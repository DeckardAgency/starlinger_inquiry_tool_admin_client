<div class="order-view">

    <app-breadcrumbs [items]="breadcrumbs"></app-breadcrumbs>

    <header class="order-view__header">
        <div class="order-view__header-left">
            <button class="order-view__back-button" (click)="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M7.99998 12.6668L3.33331 8.00016M3.33331 8.00016L7.99998 3.3335M3.33331 8.00016H12.6666" stroke="#232323" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="order-view__title-container">
                <h1 class="order-view__title">
                    <svg class="order-view__icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    Inquiry ID: {{ order?.orderNumber }}
                </h1>
                <span class="order-view__status" [ngClass]="getStatusClass()">{{ getSavedStatusLabel() }}</span>
            </div>
        </div>
        <div class="order-view__header-right">
            <button class="order-view__export-button" (click)="exportOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M14 10V12.6667C14 13.0203 13.8595 13.3594 13.6095 13.6095C13.3594 13.8595 13.0203 14 12.6667 14H3.33333C2.97971 14 2.64057 13.8595 2.39052 13.6095C2.14048 13.3594 2 13.0203 2 12.6667V10M4.66667 6.66667L8 10M8 10L11.3333 6.66667M8 10V2" stroke="#232323" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Export
            </button>

            <button class="order-view__print-button" (click)="printOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <g clip-path="url(#clip0_891_32045)">
                        <path d="M4.00004 11.9999H2.66671C2.31309 11.9999 1.97395 11.8594 1.7239 11.6094C1.47385 11.3593 1.33337 11.0202 1.33337 10.6666V7.33325C1.33337 6.97963 1.47385 6.64049 1.7239 6.39044C1.97395 6.14039 2.31309 5.99992 2.66671 5.99992H13.3334C13.687 5.99992 14.0261 6.14039 14.2762 6.39044C14.5262 6.64049 14.6667 6.97963 14.6667 7.33325V10.6666C14.6667 11.0202 14.5262 11.3593 14.2762 11.6094C14.0261 11.8594 13.687 11.9999 13.3334 11.9999H12M4.00004 5.99992V1.99992C4.00004 1.82311 4.07028 1.65354 4.1953 1.52851C4.32033 1.40349 4.4899 1.33325 4.66671 1.33325H11.3334C11.5102 1.33325 11.6798 1.40349 11.8048 1.52851C11.9298 1.65354 12 1.82311 12 1.99992V5.99992M4.66671 9.33325H11.3334C11.7016 9.33325 12 9.63173 12 9.99992V13.9999C12 14.3681 11.7016 14.6666 11.3334 14.6666H4.66671C4.29852 14.6666 4.00004 14.3681 4.00004 13.9999V9.99992C4.00004 9.63173 4.29852 9.33325 4.66671 9.33325Z" stroke="#232323" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs>
                        <clipPath id="clip0_891_32045">
                            <rect width="16" height="16" fill="white"/>
                        </clipPath>
                    </defs>
                </svg>
                Print
            </button>

            <button class="order-view__save-button"
                    (click)="saveOrder()"
                    [class.order-view__save-button--has-changes]="hasUnsavedChanges()">
                Save
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M2.66657 9.9326C2.17126 9.42654 1.79761 8.81441 1.57392 8.14256C1.35023 7.47071 1.28237 6.75676 1.37547 6.0548C1.46858 5.35284 1.7202 4.68127 2.1113 4.09096C2.50239 3.50064 3.02269 3.00708 3.63279 2.64763C4.24289 2.28819 4.92678 2.0723 5.63268 2.01632C6.33857 1.96033 7.04795 2.06572 7.70708 2.32451C8.36621 2.58329 8.9578 2.98867 9.43706 3.50996C9.91631 4.03124 10.2706 4.65475 10.4732 5.33327H11.6666C12.3102 5.33319 12.9369 5.54015 13.4539 5.92356C13.9709 6.30697 14.3509 6.84651 14.5377 7.46247C14.7246 8.07843 14.7084 8.73815 14.4915 9.34418C14.2746 9.95021 13.8685 10.4704 13.3332 10.8279M8 7.99992V13.9999M8 7.99992L10.6667 10.6666M8 7.99992L5.33333 10.6666" stroke="white" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </header>

    <div class="order-view__content">
        <!-- Display loading state -->
        <div class="order-view__loading" *ngIf="isLoading">
            <div class="order-view__spinner"></div>
            <p>Loading order details...</p>
        </div>

        <!-- Display error message if there's an error -->
        <div class="order-view__error" *ngIf="error && !isLoading">
            <p>{{ error }}</p>
            <button class="order-view__retry-button" (click)="loadOrderData()">Retry</button>
        </div>

        <!-- Display order details when loaded -->
        <div class="order-view__details" *ngIf="!isLoading && !error">
            <div class="order-view__info-row">
                <!-- Basic Information Section -->
                <div class="order-view__info-card">
                    <h2 class="order-view__section-title">Basic information</h2>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Order Number</span>
                        <span class="order-view__field-value">{{ order?.orderNumber || 'N/A' }}</span>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">User</span>
                        <span class="order-view__field-value">{{ order?.user?.firstName + ' ' + order?.user?.lastName }}</span>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Billing address</span>
                        <div class="order-view__field-value">
                            <span>{{ order?.billingAddress || 'No billing address' }}</span>
                        </div>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Created</span>
                        <span class="order-view__field-value">{{ order?.createdAt | dateFilter:'dd.MM.yyyy @ HH:mm' }}</span>
                    </div>

                    <form [formGroup]="statusForm">
                        <div class="order-view__field order-view__field--status">
                            <span class="order-view__field-label">Status</span>
                            <div class="order-view__field-select">
                                <app-select
                                    class="order-select"
                                    formControlName="status"
                                    [options]="statusOptions"
                                    [clearable]="false"
                                    displayField="label"
                                    valueField="value"
                                    (selectionChange)="onStatusChange($event)"
                                    placeholder="Select status">
                                </app-select>
                            </div>
                        </div>
                    </form>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Last saved</span>
                        <span class="order-view__field-value">{{ order?.lastSavedAt | dateFilter:'dd.MM.yyyy @ HH:mm' }}</span>
                    </div>
                </div>

                <!-- Order Address Section -->
                <div class="order-view__info-card">
                    <h2 class="order-view__section-title">Order address</h2>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Shipping address</span>
                        <div class="order-view__field-value">
                            <span>{{ order?.shippingAddress || 'No shipping address' }}</span>
                        </div>
                    </div>

                    <div class="order-view__field" *ngIf="order?.notes">
                        <span class="order-view__field-label">Notes</span>
                        <span class="order-view__field-value">{{ order?.notes }}</span>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Price without tax</span>
                        <span class="order-view__field-value">€ {{ priceWithoutTax | priceFilterAdvanced }}</span>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Total price</span>
                        <span class="order-view__field-value">€ {{ grandTotal | priceFilterAdvanced }}</span>
                    </div>

                    <div class="order-view__field">
                        <span class="order-view__field-label">Price tax (20%)</span>
                        <span class="order-view__field-value">€ {{ priceTax | priceFilterAdvanced }}</span>
                    </div>
                </div>
            </div>

            <!-- Products Ordered Section -->
            <div class="order-view__products-section">
                <h2 class="order-view__section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <g clip-path="url(#clip0_825_105576)">
                            <path d="M4.58332 7.08341L7.49999 10.0001L4.58332 12.9167L1.66666 10.0001L4.58332 7.08341Z" stroke="#71717A" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9.99999 1.66675L12.9167 4.58341L9.99999 7.50008L7.08332 4.58341L9.99999 1.66675Z" stroke="#71717A" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15.4167 7.08341L18.3333 10.0001L15.4167 12.9167L12.5 10.0001L15.4167 7.08341Z" stroke="#71717A" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9.99999 12.5001L12.9167 15.4167L9.99999 18.3334L7.08332 15.4167L9.99999 12.5001Z" stroke="#71717A" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                            <clipPath id="clip0_825_105576">
                                <rect width="20" height="20" fill="white"/>
                            </clipPath>
                        </defs>
                    </svg>
                    Products ordered
                </h2>

                <!-- Products section with real data -->
                <div class="order-view__products-table" *ngIf="order?.items">
                    <table class="order-view__table">
                        <thead>
                        <tr>
                            <th class="order-view__table-header">Part no.</th>
                            <th class="order-view__table-header">Product name</th>
                            <th class="order-view__table-header">Weight</th>
                            <th class="order-view__table-header">Quantity</th>
                            <th class="order-view__table-header">Unit price</th>
                            <th class="order-view__table-header">Discount</th>
                            <th class="order-view__table-header">Price</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="order-view__table-row" *ngFor="let item of order?.items">
                            <td class="order-view__table-cell">{{ item.product.partNo }}</td>
                            <td class="order-view__table-cell">{{ item.product.name }}</td>
                            <td class="order-view__table-cell">{{ item.product.weight }}</td>
                            <td class="order-view__table-cell">{{ item.quantity }}</td>
                            <td class="order-view__table-cell">€ {{ item.unitPrice | priceFilterAdvanced }}</td>
                            <td class="order-view__table-cell"></td>
                            <td class="order-view__table-cell">€ {{ item.subtotal | priceFilterAdvanced }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Empty state -->
                <div class="order-view__empty-state" *ngIf="!order?.items">
                    <p>No products in this order</p>
                </div>

                <!-- Total section -->
                <div class="order-view__total-section">
                    <div class="order-view__total-row">
                        <span class="order-view__total-label">Total price</span>
                        <span class="order-view__total-value">€ {{ grandTotal | priceFilterAdvanced }}</span>
                    </div>
                </div>
            </div>

            <!-- Log Messages Section -->
            <div class="logs-section" *ngIf="order?.logs">
                <h2 class="logs-section__title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M13.3333 13.3333L15 14.9999L18.3333 11.6666M17.5 8.33317V6.6665C17.4997 6.37423 17.4225 6.08718 17.2763 5.83414C17.13 5.5811 16.9198 5.37097 16.6667 5.22484L10.8333 1.8915C10.58 1.74522 10.2926 1.66821 10 1.66821C9.70744 1.66821 9.42003 1.74522 9.16667 1.8915L3.33333 5.22484C3.08022 5.37097 2.86998 5.5811 2.72372 5.83414C2.57745 6.08718 2.5003 6.37423 2.5 6.6665V13.3332C2.5003 13.6254 2.57745 13.9125 2.72372 14.1655C2.86998 14.4186 3.08022 14.6287 3.33333 14.7748L9.16667 18.1082C9.42003 18.2545 9.70744 18.3315 10 18.3315C10.2926 18.3315 10.58 18.2545 10.8333 18.1082L12.5 17.1582M6.25 3.55827L13.75 7.84993M2.7417 5.83325L10 9.99992M10 9.99992L17.2584 5.83325M10 9.99992L10 18.3333" stroke="#71717A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Log messages
                </h2>

                <div class="logs-section__container">
                    <div class="logs-section__item" *ngFor="let log of order?.logs">
                        <div class="logs-section__status" [ngClass]="getLogStatusClass(log.newStatus)">{{ log.newStatus }}</div>
                        <div class="logs-section__date">{{ log.createdAt | dateFilter:'dd.MM.yyyy @ HH:mm' }}</div>
                        <div class="logs-section__user">System</div>
                        <div class="logs-section__comment">{{ log.comment }}</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
